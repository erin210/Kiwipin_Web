<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <meta name="format-detection" content="telephone=no" />
    <title>api-wallet</title>
    <script src="config.js"></script>
    <script>
        (function () {
            var base = document.createElement('base');
            base.href = window.pageBaseUrl;
            document.head.appendChild(base);
        })();
    </script>
    <script src="./assets/js/jquery-3.7.1.min.js"></script>
    <link rel="stylesheet" href="./assets/css/reset.css">
    <link rel="stylesheet" href="./assets/css/bootstrap-grid.css">
    <link rel="stylesheet" href="./assets/css/select2.min.css" />
    <link rel="stylesheet" href="./assets/css/wallet.css?v=241008">
    <script>
        function initFunction(jsonObj) {
            renderInfo(jsonObj);
        }
    </script>
</head>

<body class="walletLogin">
    <div id="apiWallet">
        <div class="container">
            <aside>
                <div class="logo">
                    <img src="./assets/img/logo3.svg" alt="" >
                </div>
                <div class="tabs tab_nnn">
                    <div class="tab tab1">
                        <a href="member_login.html">
                            <i class="oo1"></i>
                            <i class="oo2"></i>
                            <h3><span>登入</span></h3>
                        </a>
                    </div>
                    <div class="tab tab2 active">
                        <a href="member_reg.html">
                            <i class="oo1"></i>
                            <i class="oo2"></i>
                            <h3><span>註冊</span></h3>
                        </a>
                    </div>
                </div>
            </aside>
            
            <div class="tab_container">
                <div class="logo">
                    <img src="./assets/img/logo1.svg" alt="">
                </div>
                    <!-- tab1 op-->
                    <div id="tab1" class="tab_content">
                        <form role="form" id="form" action="" method="post" target="_self" class="form-payment" onsubmit="return check_submit();">
                            <div class="form_list reg">
                                <h4>註冊</h4>
                                <ul>
                                    <li class="check_code email">
                                        <span>會員信箱</span>
                                        <div id="send_code" class="send_code">
                                            <input type="text" name="U_EMAIL" id="U_EMAIL" placeholder="請輸入Email">
                                            <a id="SEND_VERIFY_CODE" href="javascript:void(0)"
                                                onclick="return send_VERIFY_CODE();">發送驗證碼</a>
                                            <div id="countdown" class="countdown send_code" style="display: none;"><a><img src="assets/img/icon_check_ok.svg" alt=""> 已發送( <span id="countdown_second">0</span>)</a></div>
                                        </div>
                                        <div class="wrong_msg email_msg" style="display:none"><img src="./assets/img/icon_error.svg" alt=""><span
                                                class="email_msg_text">無效的帳號</span></div>
                                    </li>
                                    <li class="check_code">
                                        <span>驗證碼</span>
                                        <input type="text" name="U_VERIFY_CODE" id="U_VERIFY_CODE" placeholder="驗證碼">
                                        <div class="wrong_msg verify_code_msg" style="display:none"><img src="./assets/img/icon_error.svg" alt=""><span class="verify_code_msg_text">請填寫驗證碼</span></div>
                                    </li>
                                    <li class="check_code">
                                        <span>登入密碼</span>
                                        <div class="code_PW">
                                            <input class="input_visible" type="password" name="U_PASSWORD" id="U_PASSWORD">
                                            <img class="togglePassword" src="./assets/img/icon_eye_close.svg" alt="eye">
                                
                                        </div>
                                        <div class="wrong_msg password_msg" style="display:none"><i class="icon"><img src="./assets/img/icon_error.svg"></i><small
                                                class="password_msg_text">請選用安全強度較高的密碼，建議您混用字母、數字和符號。</small>
                                        </div>
                                    </li>
                                    <li class="check_code">
                                        <span>交易密碼</span>
                                        <div class="code_PW">
                                            <input class="input_visible" type="password" name="U_PAY_PASSWORD" id="U_PAY_PASSWORD">
                                            <img class="togglePassword" src="./assets/img/icon_eye_close.svg" alt="eye">
                                        </div>
                                        <div class="wrong_msg password_msg" style="display:none"><i class="icon"><img src="./assets/img/icon_error.svg"></i><small
                                                class="password_msg_text">請選用安全強度較高的密碼，建議您混用字母、數字和符號。</small>
                                        </div>
                                    </li>
                                    <li class="check_code">
                                        <span>確認交易密碼</span>
                                        <div class="code_PW">
                                            <input class="input_visible_check" type="password" name="U_PAY_PASSWORD_CHECK" id="U_PAY_PASSWORD_CHECK"
                                                placeholder="請再次輸入帳戶新密碼">
                                            <img class="togglePassword" src="./assets/img/icon_eye_close.svg" alt="eye">
                                        </div>
                                        <div class="wrong_msg new_password_check_msg" style="display:none">
                                            <i class="icon"><img src="./assets/img/icon_error.svg"></i><small
                                                class="new_password_check_msg_text">密碼不符</small>
                                        </div>
                                    </li>
                                </ul>
                                <!--<a href="member_forget_pw.html" class="btn btn_blue">上一步</a>-->
                                <div class="form_bt">
                                    <div class="terms">
                                        <input id="agree" type="checkbox" id="terms">
                                        <label for="terms">閱讀並同意 
                                            <a href="https://www.kiwipin.com/terms_of_service">會員服務條款</a>、
                                            <a href="https://www.kiwipin.com/privacy_policy">隱私權政策</a>
                                        </label>
                                        <div class="wrong_msg agree_msg" style="display:none"><img src="./assets/img/icon_error.svg" alt=""><span class="agree_msg_text">請勾選同意</span></div>
                                    </div>
                                    <a id="confirm" href="javascript:void(0)" onclick="return check_submit();" class="btn btn_blue">註冊</a>
                                </div>
                            </div>
                        </form>
                    </div>
                    <!-- tab1 ed-->
            </div>
        </div>
    </div>
    <!--popup_1-->
    <div id="popup" class="popup" style="display: none;">
      <div class="popup_wrapper">
          <div class="content">
            <img class="icon popup_icon popup_icon_success" src="./assets/img/icon_success.svg" alt="">
            <img class="icon popup_icon popup_icon_error" src="./assets/img/icon_error.svg" alt="">
              <h1 id="popup_title" class="title">註冊成功</h1>
              <h1 id="popup_notice" class="notice">註冊成功，請重新登入</h1>
          </div>
          <a id="popup_a" href="javascript:void(0)" onclick="$('#popup').hide();" class="btn confirm btn_pop_close">確認</a>
      </div>
  </div>

    <script>
        $(function () {
            $('base').attr('href', apiUrl);
        });

        function renderInfo(json) {
        
        if(json.ErrorMessage !== null && json.ErrorMessage !== undefined) {
          if(json.ErrorMessage.indexOf("帳號") != -1){
            $('.email_msg_text').text(json.ErrorMessage);
            $('.email_msg').show();
          }else{
            $('.password_msg_text').text(json.ErrorMessage);
            $('.password_msg').show();          
          }
        }
        
        Object.keys(json).forEach(function(k){
          var eleName = '#' + k;
          //console.log(eleName + ' - ' + json[k]);
          if ($(eleName).length <= 0) {
            appendElement_Input('#form',k,json[k]);
          }else{
            $(eleName).val(json[k]);
          }
        });   
      
      }

      //密碼眼睛
      $('.togglePassword').on('click', function() {
            const passwordField = $(this).siblings('input');
            const isPasswordVisible = passwordField.attr('type') === 'text';
            passwordField.attr('type', isPasswordVisible ? 'password' : 'text');

            const newIconSrc = isPasswordVisible ? pageBaseUrl+'/assets/img/icon_eye_close.svg' : pageBaseUrl+'/assets/img/icon_eye_open.svg';
            $(this).attr('src', newIconSrc);
        });
      
      function appendElement_Input(ele, name, value) {
        var textHtml = '<input type="hidden" name="' + name + '"';
        textHtml += ' value="' + value + '"';
        textHtml += '/>';
        $(ele).append(textHtml);
      }
      
      function preventScroll(e) {
        e.preventDefault(); // 禁止滾動
      }

      //發送驗證碼
      function send_VERIFY_CODE() {
        $('.email_msg').hide();
        if (!check_U_EMAIL()) return false;

        $('#SEND_VERIFY_CODE, #U_EMAIL').attr('disabled', true).text('發送中...');
        timer_countdown(180, "countdown_second", "timer_Finished");

        const url = "https://wallet.kiwipin.com/sendVerifyCode";
        const headers = {
            "Content-Type": "application/json",
            "Accept": "application/json",
            "Authorization": `Bearer YOUR_TOKEN`,
        };
        const body = JSON.stringify({
            "TYPE": "REGISTER",
            "EMail": $('#U_EMAIL').val()
        });

        // （測試用）op
        const simulateSuccess = false; // 設為 `false` 來模擬失敗

        if (simulateSuccess) {
            // 模擬成功回應
            setTimeout(() => {
                handleApiResponse({ SendResult: "Success", SendResult_Message: "驗證碼已發送到："+$('#U_EMAIL').val() });
            }, 1000);
        } else {
            // 模擬失敗回應
            setTimeout(() => {
                handleApiResponse({ SendResult: "Fail", SendResult_Message: "發送失敗!" });
            }, 1000);
        }
        // （測試用）ed
      }

      function handleApiResponse(json) {
          $(".popup_icon").hide();
          if (json.SendResult === "Success") {
              $(".popup_icon_success").show();
              $("#popup_title").text("驗證碼發送成功");
              // $("#popup_notice").text("驗證碼已發送到："+$('#U_EMAIL').val());
              $('#U_EMAIL').attr('disabled',true);
          } else {
              $(".popup_icon_error").show();
              $("#popup_title").text("發生錯誤了!");
          }
          $('#popup_notice').text(json.SendResult_Message);
          $("#popup").show();
          $('#SEND_VERIFY_CODE').removeAttr('disabled').text('發送驗證碼');
          $("#SEND_VERIFY_CODE").hide();
          $("#countdown").show();
      }
      
      function check_U_EMAIL(){
        if($('#U_EMAIL').val() == ""){
          $('.email_msg_text').text("需要輸入 EMail");
          $('.email_msg').show();
          $('#U_EMAIL').focus();
          return false;
        }
        
        if(!IsEmail($('#U_EMAIL').val())){
          $('.email_msg_text').text("無效的 EMail");
          $('.email_msg').show();
          $('#U_EMAIL').focus();
          return false;
        }
        return true;
      }
      
      function check_U_VERIFY_CODE(){
        if($('#U_VERIFY_CODE').val() == ""){
          $('.verify_code_msg_text').text("請填寫驗證碼");
          $('.verify_code_msg').show();
          $('#U_VERIFY_CODE').focus();
          return false;
        }
        
        return true;
      }
      
      function check_PASSWORD(){
        if($('#U_PASSWORD').val() == ""){
          $('.password_msg_text').text("請填寫登入密碼");
          $('.password_msg').show();
          $('#U_PASSWORD').focus();
          return false;
        }
        
        if($('#U_PASSWORD_CHECK').val() == ""){
          $('.password_check_msg_text').text("請再次填寫登入密碼");
          $('.password_check_msg').show();
          $('#U_PASSWORD_CHECK').focus();
          return false;
        }
        
        if($('#U_PASSWORD').val() != $('#U_PASSWORD_CHECK').val()){
          $('.password_check_msg_text').text("二次輸入登入密碼不一致");
          $('.password_check_msg').show();
          $('#U_PASSWORD_CHECK').focus();
          return false;
        }
        
        if($('#U_PAY_PASSWORD').val() == ""){
          $('.pay_password_msg_text').text("請填寫交易密碼");
          $('.pay_password_msg').show();
          $('#U_PAY_PASSWORD').focus();
          return false;
        }
        
        if($('#U_PAY_PASSWORD_CHECK').val() == ""){
          $('.pay_password_check_msg_text').text("請再次填寫交易密碼");
          $('.pay_password_check_msg').show();
          $('#U_PAY_PASSWORD_CHECK').focus();
          return false;
        }
        
        if($('#U_PAY_PASSWORD').val() != $('#U_PAY_PASSWORD_CHECK').val()){
          $('.pay_password_check_msg_text').text("二次輸入交易密碼不一致");
          $('.pay_password_check_msg').show();
          $('#U_PAY_PASSWORD_CHECK').focus();
          return false;
        }

        return true;
      }
      
      function check_agree(){
        if(!$('#agree').is(':checked') ){
          $('.agree_msg_text').text("請勾選同意");
          $('.agree_msg').show();
          $('#agree').focus();
          return false;
        }
        return true;
      }
      
      function check_submit(){
        $('.wrong_msg').hide();
        
        if(!check_U_EMAIL()){
          return false;
        }

        if(!check_U_VERIFY_CODE()){
          return false;
        }
                
        if(!check_PASSWORD()){
          return false;
        }
        
        if(!check_agree()){
          return false;
        }
        
        document.getElementById('form').submit();
        //return true;
      }
      
      function IsEmail(email) {
        var regex = /^([a-zA-Z0-9_\.\-\+])+\@(([a-zA-Z0-9\-])+\.)+([a-zA-Z0-9]{2,4})+$/;
        if(!regex.test(email)) {
          return false;
        }else{
        return true;
        }
      }
      
      function timer_countdown(countdownTime, eleID, callFunction) {
        let temp_eleID = "#" + eleID;

        // 更新顯示的倒數秒數
        if (eleID && $(temp_eleID).length) {
            $(temp_eleID).text(countdownTime + "s");
        }

        countdownTime--;  // 倒數計時減少 1 秒

        // 檢查是否還有剩餘時間
        if (countdownTime >= 0) {
            setTimeout(function() {
                timer_countdown(countdownTime, eleID, callFunction);
            }, 1000);  // 每秒更新一次
        } else {
            // 倒數結束時執行指定的回呼函數
            if (callFunction !== undefined) {
                let functionName = callFunction.split('(')[0];
                let params = null;

                // 檢查是否有參數傳入
                if (callFunction.split('(')[1] !== undefined) {
                    params = callFunction.split('(')[1].split(')')[0];
                    params = params.replace(/^'|'$/g, '').replace(/^\"|\"$/g, '');
                    console.log(params);
                }

                // 執行回呼函數
                window[functionName](params);
            }
        }
    }

      
      function timer_Finished(){
        $("#countdown").hide();
        $("#SEND_VERIFY_CODE").show().text("重新發送");
        $('#U_EMAIL').attr('disabled',false);
      }
    </script>

<script>      
    initFunction({"Tpye":"REGISTER","U_EMAIL":"","ReturnURL":"home"});
 </script>
</body>

</html>